{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/abdo2/Desktop/work/chicken/chicken_web/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The \"setAll\" method was called from a Server Component.\r\n          // This can be ignored if you have middleware refreshing\r\n          // user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n\r\n// Service role client for admin operations - bypasses RLS\r\nexport function createServiceRoleClient() {\r\n  return createSupabaseClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF;AAGO,SAAS;IACd,OAAO,IAAA,yMAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB;AAEzC"}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/abdo2/Desktop/work/chicken/chicken_web/app/api/admin/delete-product/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { createClient, createServiceRoleClient } from \"@/lib/supabase/server\"\r\n\r\nexport async function POST(request: NextRequest) {\r\n  console.log('Delete product API called')\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Check if user is admin\r\n    const {\r\n      data: { user },\r\n      error: userError,\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (userError || !user) {\r\n      return NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      )\r\n    }\r\n\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"is_admin\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    if (!profile?.is_admin) {\r\n      return NextResponse.json(\r\n        { error: \"Admin access required\" },\r\n        { status: 403 }\r\n      )\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json()\r\n    const { productId, sellerId, sellerEmail, productName } = body\r\n\r\n    if (!productId || !sellerId) {\r\n      return NextResponse.json(\r\n        { error: \"Missing required fields\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    console.log('Deleting product:', { productId, sellerId, productName })\r\n\r\n    // First, check if the product actually exists\r\n    const { data: existingProduct, error: checkError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"*\")\r\n      .eq(\"id\", productId)\r\n      .single()\r\n\r\n    if (checkError || !existingProduct) {\r\n      console.log('Product does not exist or error checking:', checkError)\r\n      return NextResponse.json(\r\n        { error: \"Product not found or already deleted\" },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    console.log('Product found in database:', existingProduct)\r\n\r\n    // Create service role client for admin operations (bypasses RLS)\r\n    const adminClient = createServiceRoleClient()\r\n\r\n    // Delete related orders first (if any)\r\n    const { error: ordersDeleteError } = await adminClient\r\n      .from(\"orders\")\r\n      .delete()\r\n      .eq(\"product_id\", productId)\r\n      .eq(\"status\", \"pending\") // Only delete pending orders\r\n\r\n    if (ordersDeleteError) {\r\n      console.error('Error deleting related orders:', ordersDeleteError)\r\n      // Continue anyway, as this is not critical\r\n    } else {\r\n      console.log('Related orders deleted (if any)')\r\n    }\r\n\r\n    // Delete the product using service role client to bypass RLS\r\n    const { data: deletedData, error: productDeleteError } = await adminClient\r\n      .from(\"products\")\r\n      .delete()\r\n      .eq(\"id\", productId)\r\n      .eq(\"seller_id\", sellerId) // Extra security check\r\n      .select() // Return the deleted row\r\n\r\n    if (productDeleteError) {\r\n      console.error('Database error:', productDeleteError)\r\n      return NextResponse.json(\r\n        { error: `Failed to delete product: ${productDeleteError.message}` },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    console.log('Delete result:', deletedData)\r\n    \r\n    if (!deletedData || deletedData.length === 0) {\r\n      console.error('No product was deleted - possible permission issue or wrong IDs')\r\n      return NextResponse.json(\r\n        { error: \"No product was deleted - check product ID and seller ID\" },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Create a contact message as a warning to the seller\r\n    if (sellerEmail && productName) {\r\n      const warningMessage = `\r\nDear Seller,\r\n\r\nThis is an automated message to inform you that your product \"${productName}\" has been removed from the FarmEgg marketplace by our admin team.\r\n\r\nReason for removal:\r\n- Policy violation or quality concerns\r\n- Non-compliance with marketplace guidelines\r\n\r\nIf you believe this was done in error, please contact our support team immediately.\r\n\r\nTo avoid future issues:\r\n- Ensure all products meet our quality standards\r\n- Follow marketplace guidelines strictly\r\n- Provide accurate product descriptions and images\r\n\r\nBest regards,\r\nFarmEgg Admin Team\r\n      `.trim()\r\n\r\n      await adminClient.from(\"contact_messages\").insert({\r\n        name: \"FarmEgg Admin\",\r\n        email: \"admin@farmegg.com\",\r\n        phone: null,\r\n        subject: `Product Removal Warning - ${productName}`,\r\n        contact_reason: \"warning\",\r\n        message: warningMessage,\r\n        is_read: false\r\n      })\r\n\r\n      console.log('Warning message created for seller')\r\n    }\r\n\r\n    console.log('Product deleted successfully')\r\n    return NextResponse.json(\r\n      { \r\n        message: \"Product deleted successfully and warning sent to seller\",\r\n        productId\r\n      },\r\n      { status: 200 }\r\n    )\r\n\r\n  } catch (error) {\r\n    console.error('Delete product API error:', error)\r\n    return NextResponse.json(\r\n      { error: `Internal server error: ${error instanceof Error ? error.message : 'Unknown error'}` },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}