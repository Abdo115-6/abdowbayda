{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/abdo2/Desktop/work/chicken/chicken_web/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\r\nimport { cookies } from \"next/headers\"\r\n\r\nexport async function createClient() {\r\n  const cookieStore = await cookies()\r\n\r\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll()\r\n      },\r\n      setAll(cookiesToSet) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\r\n        } catch {\r\n          // The \"setAll\" method was called from a Server Component.\r\n          // This can be ignored if you have middleware refreshing\r\n          // user sessions.\r\n        }\r\n      },\r\n    },\r\n  })\r\n}\r\n\r\n// Service role client for admin operations - bypasses RLS\r\nexport function createServiceRoleClient() {\r\n  return createSupabaseClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n  )\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AACA;AACA;;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAAoF;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,0DAA0D;gBAC1D,wDAAwD;gBACxD,iBAAiB;gBACnB;YACF;QACF;IACF;AACF;AAGO,SAAS;IACd,OAAO,IAAA,yMAAoB,gFAEzB,QAAQ,GAAG,CAAC,yBAAyB;AAEzC"}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/abdo2/Desktop/work/chicken/chicken_web/app/api/admin/ban-user/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport { createClient, createServiceRoleClient } from \"@/lib/supabase/server\"\r\n\r\nexport async function POST(request: Request) {\r\n  console.log('Ban user API called')\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const {\r\n      data: { user },\r\n      error: authError,\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (authError || !user) {\r\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n\r\n    // Check if user is admin\r\n    const { data: profile } = await supabase.from(\"profiles\").select(\"is_admin\").eq(\"id\", user.id).single()\r\n\r\n    if (!profile?.is_admin) {\r\n      return NextResponse.json({ error: \"Forbidden\" }, { status: 403 })\r\n    }\r\n\r\n    const { userId, isBanned } = await request.json()\r\n\r\n    console.log('Banning/Unbanning user:', { userId, isBanned })\r\n\r\n    // Get user details before banning\r\n    const { data: targetUser, error: userError } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"email, banned_ip\")\r\n      .eq(\"id\", userId)\r\n      .single()\r\n\r\n    if (userError || !targetUser) {\r\n      console.error('Target user not found:', userError)\r\n      return NextResponse.json({ error: \"User not found\" }, { status: 404 })\r\n    }\r\n\r\n    console.log('Target user details:', targetUser)\r\n\r\n    const ip = request.headers.get(\"x-forwarded-for\") || request.headers.get(\"x-real-ip\") || \"unknown\"\r\n    \r\n    // Create service role client for admin operations (bypasses RLS)\r\n    const adminClient = createServiceRoleClient()\r\n    let deletedProductsCount = 0\r\n\r\n    if (isBanned) {\r\n      console.log('Banning user - removing products and adding to ban lists')\r\n      \r\n      // 1. Delete all user's products first\r\n      const { data: userProducts, error: productsError } = await adminClient\r\n        .from(\"products\")\r\n        .select(\"id, name\")\r\n        .eq(\"seller_id\", userId)\r\n\r\n      if (productsError) {\r\n        console.error('Error fetching user products:', productsError)\r\n      } else {\r\n        console.log('Found user products:', userProducts)\r\n        deletedProductsCount = userProducts?.length || 0\r\n        \r\n        if (userProducts && userProducts.length > 0) {\r\n          // Delete related orders first\r\n          for (const product of userProducts) {\r\n            await adminClient\r\n              .from(\"orders\")\r\n              .delete()\r\n              .eq(\"product_id\", product.id)\r\n          }\r\n\r\n          // Then delete all products\r\n          const { error: deleteProductsError } = await adminClient\r\n            .from(\"products\")\r\n            .delete()\r\n            .eq(\"seller_id\", userId)\r\n\r\n          if (deleteProductsError) {\r\n            console.error('Error deleting user products:', deleteProductsError)\r\n          } else {\r\n            console.log(`Deleted ${userProducts.length} products for banned user`)\r\n          }\r\n        }\r\n      }\r\n\r\n      // 2. Add IP to ban list (create table if needed)\r\n      if (ip !== \"unknown\") {\r\n        // Try to insert, if table doesn't exist, it will create it\r\n        try {\r\n          await adminClient\r\n            .from(\"banned_ips\")\r\n            .upsert({\r\n              ip_address: ip,\r\n              banned_by: user.id,\r\n              banned_at: new Date().toISOString(),\r\n              reason: `User ${targetUser.email} banned`\r\n            }, {\r\n              onConflict: 'ip_address'\r\n            })\r\n\r\n          console.log('Added IP to ban list:', ip)\r\n        } catch (ipError) {\r\n          console.log('Could not add IP to ban list (table may not exist):', ipError)\r\n        }\r\n      }\r\n\r\n      // 3. Add email to ban list\r\n      if (targetUser.email) {\r\n        try {\r\n          await adminClient\r\n            .from(\"banned_emails\")\r\n            .upsert({\r\n              email: targetUser.email,\r\n              banned_by: user.id,\r\n              banned_at: new Date().toISOString(),\r\n              reason: `User banned by admin`\r\n            }, {\r\n              onConflict: 'email'\r\n            })\r\n\r\n          console.log('Added email to ban list:', targetUser.email)\r\n        } catch (emailError) {\r\n          console.log('Could not add email to ban list (table may not exist):', emailError)\r\n        }\r\n      }\r\n    } else {\r\n      console.log('Unbanning user - removing from ban lists')\r\n      \r\n      // Remove from ban lists when unbanning\r\n      if (targetUser.email) {\r\n        await adminClient\r\n          .from(\"banned_emails\")\r\n          .delete()\r\n          .eq(\"email\", targetUser.email)\r\n\r\n        console.log('Removed email from ban list:', targetUser.email)\r\n      }\r\n\r\n      if (targetUser.banned_ip) {\r\n        await adminClient\r\n          .from(\"banned_ips\")\r\n          .delete()\r\n          .eq(\"ip_address\", targetUser.banned_ip)\r\n\r\n        console.log('Removed IP from ban list:', targetUser.banned_ip)\r\n      }\r\n    }\r\n\r\n    // Update user ban status and store IP if banning\r\n    const updateData: any = { is_banned: isBanned }\r\n    if (isBanned) {\r\n      updateData.banned_ip = ip\r\n      updateData.banned_at = new Date().toISOString()\r\n    } else {\r\n      // Clear banned IP and date when unbanning\r\n      updateData.banned_ip = null\r\n      updateData.banned_at = null\r\n    }\r\n\r\n    const { error: updateError } = await adminClient\r\n      .from(\"profiles\")\r\n      .update(updateData)\r\n      .eq(\"id\", userId)\r\n\r\n    if (updateError) {\r\n      console.error('Error updating user ban status:', updateError)\r\n      return NextResponse.json({ error: updateError.message }, { status: 500 })\r\n    }\r\n\r\n    console.log('User ban status updated successfully')\r\n\r\n    // Send warning message to banned user\r\n    if (isBanned && targetUser.email) {\r\n      const warningMessage = `\r\nDear User,\r\n\r\nYour account has been banned from the FarmEgg marketplace due to policy violations.\r\n\r\nActions taken:\r\n- Your account has been suspended\r\n- All your products have been removed from the marketplace\r\n- Your IP address and email have been added to our ban list\r\n\r\nIf you believe this was done in error, please contact our support team immediately.\r\n\r\nTo avoid future issues:\r\n- Follow our community guidelines\r\n- Respect other users and sellers\r\n- Only post legitimate products and services\r\n\r\nBest regards,\r\nFarmEgg Admin Team\r\n      `.trim()\r\n\r\n      await adminClient.from(\"contact_messages\").insert({\r\n        name: \"FarmEgg Admin\",\r\n        email: \"admin@farmegg.com\",\r\n        phone: null,\r\n        subject: `Account Ban Notice`,\r\n        contact_reason: \"ban_notice\",\r\n        message: warningMessage,\r\n        is_read: false\r\n      })\r\n\r\n      console.log('Ban notice sent to user')\r\n    }\r\n\r\n    return NextResponse.json({ \r\n      success: true,\r\n      message: isBanned \r\n        ? `User banned successfully. Removed ${deletedProductsCount} products and added IP/email to ban lists.`\r\n        : \"User unbanned successfully and removed from ban lists.\"\r\n    })\r\n  } catch (error) {\r\n    console.error('Ban user API error:', error)\r\n    return NextResponse.json({ \r\n      error: `Failed to update user status: ${error instanceof Error ? error.message : 'Unknown error'}` \r\n    }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}